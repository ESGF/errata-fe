!function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,t,r){"use strict";r.r(t),r.d(t,"COPYRIGHT_YEAR",function(){return i}),r.d(t,"FULLTITLE",function(){return n}),r.d(t,"LONG_NAME",function(){return a}),r.d(t,"NAME",function(){return o}),r.d(t,"ORGANIZATION",function(){return s}),r.d(t,"VERSION",function(){return d}),r.d(t,"events",function(){return u}),r.d(t,"log",function(){return c}),r.d(t,"on",function(){return l}),r.d(t,"trigger",function(){return p});const i=(new Date).getFullYear(),n="ES-DOC Dataset Errata",a="Dataset Errata",o="Errata",s="ES-DOC",d="2.0.0",u=_.extend({},Backbone.Events),c=e=>{console.log(new Date+" :: "+s+"-"+o.toUpperCase()+" :: "+e)},l=(e,t,r)=>{u.on(e,t,r)},p=(e,t)=>(c("event :: "+e),u.trigger(e,t))},function(e,t,r){"use strict";r.r(t),r.d(t,"EMAIL",function(){return G}),r.d(t,"ISSUE",function(){return J}),r.d(t,"MISC",function(){return Y}),r.d(t,"SECURITY",function(){return W}),r.d(t,"URLS",function(){return q});var i={};r.r(i),r.d(i,"CONTACT",function(){return d}),r.d(i,"SUPPORT",function(){return u}),r.d(i,"SUBJECT",function(){return c}),r.d(i,"MESSAGE",function(){return l});var n={};r.r(n),r.d(n,"MODERATION_STATUS_ACCEPTED",function(){return p}),r.d(n,"MODERATION_STATUS_IN_REVIEW",function(){return h}),r.d(n,"MODERATION_STATUS_NOT_REQUIRED",function(){return f}),r.d(n,"MODERATION_STATUS_REJECTED",function(){return E});var a={};r.r(a),r.d(a,"LOGGING_PREFIX",function(){return g}),r.d(a,"NULL_FIELD",function(){return A}),r.d(a,"UI_UPDATE_DELAY",function(){return S});var o={};r.r(o),r.d(o,"USER_ROLE_ANONYMOUS",function(){return _}),r.d(o,"USER_ROLE_AUTHOR",function(){return m}),r.d(o,"USER_ROLE_MODERATOR",function(){return T});var s={};r.r(s),r.d(s,"API_BASE_URL",function(){return I}),r.d(s,"API_PUBLICATION_CREATE",function(){return O}),r.d(s,"API_PUBLICATION_MODERATE",function(){return U}),r.d(s,"API_PUBLICATION_PROPOSE",function(){return v}),r.d(s,"API_PUBLICATION_RETRIEVE",function(){return R}),r.d(s,"API_PUBLICATION_RETRIEVE_ALL",function(){return D}),r.d(s,"API_PUBLICATION_UPDATE",function(){return P}),r.d(s,"API_OAUTH_AUTHORIZE",function(){return C}),r.d(s,"API_PID_RESOLVE",function(){return N}),r.d(s,"API_PID_TASK_QUEUE_SEARCH",function(){return L}),r.d(s,"API_PID_TASK_QUEUE_SEARCH_SETUP",function(){return b}),r.d(s,"API_SEARCH",function(){return w}),r.d(s,"API_SEARCH_MODERATION",function(){return M}),r.d(s,"API_SEARCH_SETUP",function(){return x}),r.d(s,"DOCUMENTATION",function(){return y}),r.d(s,"DOCUMENTATION_PID",function(){return $}),r.d(s,"PAGE_MODERATE",function(){return k}),r.d(s,"PAGE_HOME",function(){return j}),r.d(s,"PAGE_EDIT",function(){return F}),r.d(s,"PAGE_PID",function(){return V}),r.d(s,"PAGE_SEARCH",function(){return B}),r.d(s,"PAGE_VIEW",function(){return H});const d="support@errata.es-doc.org",u="support@errata.es-doc.org",c="ES-DOC ERRATA :: subject goes here",l="Dear ES-DOC ERRATA support team,",p="accepted",h="in-review",f="not-required",E="rejected",g="ES-DOC-ERRATA :: ",A="--",S=1e3,_="anonymous",m="author",T="moderator",I=window.origin,O="/2/publication/create",U="/2/publication/moderate",v="/2/publication/propose",R="/2/publication/retrieve",D="/2/publication/retrieve-all",P="/2/publication/update",C=window.location.origin+"/oauth/authorize",N="/1/resolve/pid",L="/1/pid-queue/search",b="/1/pid-queue/search-setup",w="/2/search/errata",M="/2/search/errata/moderation",x="/2/search/errata/setup",y="https://es-doc.github.io/esdoc-errata-client/",$="https://es-doc.github.io/esdoc-errata-client/lookup.html",k="/static/moderate.html",j="https://es-doc.org",F="/static/edit.html",V="pid.html",B="/static/index.html",H="/static/view.html",G=i,J=n,Y=a,W=o,q=s},function(e,t,r){"use strict";r.r(t),r.d(t,"openURL",function(){return a}),r.d(t,"openDocumentation",function(){return o}),r.d(t,"openPIDDocumentation",function(){return s}),r.d(t,"openHomepage",function(){return d}),r.d(t,"openEmail",function(){return u}),r.d(t,"openSupportEmail",function(){return c}),r.d(t,"render",function(){return l}),r.d(t,"renderHTML",function(){return p}),r.d(t,"renderTemplate",function(){return f}),r.d(t,"getURLParam",function(){return E}),r.d(t,"getPageCount",function(){return g}),r.d(t,"getPages",function(){return A}),r.d(t,"displayFeedback",function(){return S}),r.d(t,"hideFeedback",function(){return m}),r.d(t,"displayInfoDialog",function(){return T}),r.d(t,"hideInfoDialog",function(){return I}),r.d(t,"generateUUID",function(){return O});var i=r(0),n=r(1);const a=(e,t)=>{!0===t?window.open(e):window.location=e},o=()=>{a(n.URLS.DOCUMENTATION,!0)},s=()=>{a(n.URLS.DOCUMENTATION_PID,!0)},d=()=>{a(n.URLS.PAGE_HOME,!0)},u=(e,t,r)=>{var i="mailto:{0}?subject={1}&body={2}";t=t||n.EMAIL.SUBJECT,r=r||n.EMAIL.MESSAGE,i=(i=(i=i.replace("{0}",e)).replace("{1}",t)).replace("{2}",r),window.location.href=i},c=()=>{var e;e=(e=(e="ES-DOC :: SUPPORT :: {0} (v{1})").replace("{0}",i.NAME.toUpperCase())).replace("{1}",i.VERSION),u(n.EMAIL.SUPPORT,e)},l=(e,t,r)=>{var i,n,a=[];return i=_.isArray(e)?e:[e],_.each(i,function(e){n=new e(t).render(),a.push(n),_.isUndefined(r)||(_.has(r,"$el")?r.$el.append(n.$el):r.append(n.$el))},void 0),1===i.length?a[0]:a},p=(e,t,r)=>{var i=t?e(t):e();_.isUndefined(r)||(_.has(r,"$el")?r.$el.append(i):r.append(i))},h={},f=(e,t,r)=>{var n;if(i.log(`template: ${e}`),_.has(h,e)||(h[e]=_.template($("#"+e).html())),n=(0,h[e])(t),r&&r.$el)r.$el.append(n);else{if(!r)return n;r.replaceWith(n)}},E=(e,t)=>{var r=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(window.location.href);return r?(r[1]||t).toUpperCase():t},g=function(e,t){var r=0;return t&&t/e>(r=parseInt(t/e,10))&&(r+=1),r},A=(e,t)=>_.map(_.range(g(e,t.length)),function(t){return{id:t+1,data:this.slice(t*e,(t+1)*e-1)}},t),S=e=>{$("#feedbackText").text(e+" ... please wait"),$(".feedback-title").text(i.FULLTITLE),$(".feedback-version").text("v"+i.VERSION),$("#feedbackContainer").modal({backdrop:"static",keyboard:!1,show:!0})},m=()=>{$("#feedbackContainer").modal("hide")},T=(e,t)=>{$("#infoDialogText").text(e),$(".infoDialog-title").text(i.FULLTITLE),$(".infoDialog-version").text("v"+i.VERSION),t&&$("#infoDialogContainer").on("hide.bs.modal",t),$("#infoDialogContainer").modal({backdrop:"static",keyboard:!1,show:!0})},I=()=>{$("#infoDialog").modal("hide")},O=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:3&r|8).toString(16)})}},function(e,t,r){"use strict";r.d(t,"a",function(){return n});var i=r(1);class n{constructor(){this.oauthCredentials=Cookies.get("errata-oauth-credentials"),this.isAuthenticated=!1===_.isUndefined(this.oauthCredentials),this.isModerator=this.isAuthenticated&&Cookies.get("errata-user-role")===i.SECURITY.USER_ROLE_MODERATOR,this.isAuthor=this.isAuthenticated&&Cookies.get("errata-user-role")===i.SECURITY.USER_ROLE_AUTHOR,this.isAnonymous=!(this.isModerator||this.isAuthor)}}},function(e,t,r){"use strict";r.r(t);var i={};r.r(i),r.d(i,"issue",function(){return d}),r.d(i,"user",function(){return u});var n=r(0),a=r(2),o=r(1),s=r(3);const d=new class{constructor(){this.datasets=[],this.description=null,this.materials=[],this.project=null,this.status="new",this.moderationStatus="not-required",this.title=null,this.uid=a.getURLParam("uid")||a.generateUUID(),this.isNew=!a.getURLParam("uid"),this.urls=[],this.setHash()}get fullTitle(){if(this.isNew)return"New Issue";let e;return e=this.project.toUpperCase(),e+=" - ",e+=this.title.slice(0,48),this.title.length>48&&(e+="..."),e}get hasChanged(){return this.stateHash!==JSON.stringify(this.encode())}setHash(){this.stateHash=JSON.stringify(this.encode())}decode(e){this.datasets=e.datasets,this.description=e.description,this.materials=e.materials,this.project=e.project,this.severity=e.severity,this.status=e.status,this.moderationStatus=e.moderationStatus,this.moderationWindow=e.moderationWindow,this.title=e.title,this.uid=e.uid,this.urls=e.urls}encode(){return{datasets:this.datasets,description:this.description,materials:this.materials,moderationStatus:this.moderationStatus,project:this.project,severity:this.severity,status:this.status,title:this.title,uid:this.uid,urls:this.urls,userEmail:this.email}}},u=new s.a;n.on("field:change:aborted",e=>{const t=c(e.id);d[t]=_.isArray(e.value)?[]:null}),n.on("field:change:verified",e=>{const t=c(e);d[t]=e.value}),n.on("errata:save:start",()=>{d.hasChanged?n.trigger("errata:save:dispatch"):n.trigger("errata:save:abort")});const c=e=>"moderation-status"===e.id?"moderationStatus":e.id,l="Required field - you must enter a value.";validate.validators.presence.options={message:l},validate.validators.materialsValidator=function(e){if(0===e.length)return;const t=["jpg","gif","png","tiff"];return _.filter(e,e=>_.isObject(validate({field:e},{field:{url:!0}}))||!1===_.contains(t,_.last(e.split(".")))).length>0?"Must be a list of valid image file links (.jpg, .gif, .png, .tiff).":void 0},validate.validators.urlsValidator=function(e){if(0!==e.length)return _.filter(e,e=>_.isObject(validate({field:e},{field:{url:!0}}))).length>0?"Must be a list of valid links.":void 0},validate.validators.datasetsValidator=function(e){if(0===e.length)return l;console.log("TODO: Check datasets prefixed with project code"),console.log("TODO: POST datasets to server for validation")};const p={datasets:{datasetsValidator:{}},description:{presence:!0,length:{minimum:16,maximum:1023,message:"Must be 16 to 1023 characters."}},email:{email:{message:"Must be a valid email address."}},materials:{materialsValidator:{}},"moderation-status":{presence:!0,inclusion:{within:[o.ISSUE.MODERATION_STATUS_ACCEPTED,o.ISSUE.MODERATION_STATUS_IN_REVIEW,o.ISSUE.MODERATION_STATUS_NOT_REQUIRED,o.ISSUE.MODERATION_STATUS_REJECTED],message:l}},project:{presence:!0,inclusion:{within:["cmip5","cmip6","cordex","input4mips"],message:l}},severity:{presence:!0,inclusion:{within:["low","medium","high","critical"],message:l}},status:{presence:!0,inclusion:{within:["new","onhold","resolved","wontfix"],message:l}},title:{presence:!0,length:{minimum:16,maximum:255,message:"Must be 16 to 255 characters."}},urls:{urlsValidator:{}}};n.on("field:change",e=>{const t={},r={};t[e.id]=""===e.value?null:e.value,r[e.id]=p[e.id];const i=validate(t,r,{fullMessages:!1});i?(e.err=i[e.id][0],n.trigger("field:change:aborted",e)):n.trigger("field:change:verified",e)});const h=["project","title","description","severity","urls","materials","datasets"],f=["description","severity","status","urls","materials","datasets"];var E=Backbone.View.extend({events:{"click img.esdoc-logo":function(e){a.openHomepage()},"click a.esdoc-support":function(e){a.openSupportEmail()},"click a.esdoc-docs":()=>{a.openDocumentation()},"click button.esdoc-errata-save":function(e){const t=d.isNew?h:f;_.each(t,this.setFieldValue,this),$(".field-value").hasClass("has-error")?n.trigger("errata:save:invalidated"):n.trigger("errata:save:start")},"click a.esdoc-moderate-accept":function(e){n.trigger("errata:moderate",o.ISSUE.MODERATION_STATUS_ACCEPTED)},"click a.esdoc-moderate-review":function(e){n.trigger("errata:moderate",o.ISSUE.MODERATION_STATUS_IN_REVIEW)},"click a.esdoc-moderate-reject":function(e){n.trigger("errata:moderate",o.ISSUE.MODERATION_STATUS_REJECTED)},"change .form-control":function(e){this.setFieldValue($(e.target).attr("id"))}},initialize:function(){n.on("field:change:aborted",this._onFieldChange,this),n.on("field:change:verified",this._onFieldChange,this),n.on("errata:save:dispatch:error",this._onSaveToServerError,this),n.on("errata:moderate:dispatch:success",this._onModerationStatusChange,this)},render:function(){return a.renderTemplate("template-header",null,this),a.renderTemplate("template-issue",null,this),this.setPageTitle(),this},setFieldValue:function(e){let t=$("#"+e).val().trim();_.contains(["urls","materials","datasets"],e)&&(t=t.split("\n"),t=_.map(t,e=>e.trim()),t=_.uniq(t),t=_.filter(t,e=>e.length>0)),n.trigger("field:change",{id:e,value:t})},setPageTitle:function(){let e="ES-DOC - Errata - ";d.isNew?u.isAuthenticated?e+="Create Issue":e+="Propose Issue":e+="Edit Issue",$(document).prop("title",e)},_onFieldChange:function(e){e.err?(this.$("."+e.id).addClass("has-error"),this.$("#"+e.id+"ErrorMessage").text(e.err)):(this.$("."+e.id).removeClass("has-error"),this.$("#"+e.id+"ErrorMessage").text(""))},_onModerationStatusChange:function({moderationStatus:e}){$("#moderationStatus").val(e.toUpperCase())},_onSaveToServerError:function({responseJSON:e}){e.errorField&&(this.$(".field-value ."+e.errorField).addClass("has-error"),this.$("#"+e.errorField+"ErrorMessage").text(e.errorMessage))}});n.on("setup:begin",()=>{var e,t;d.isNew?n.trigger("setup:complete"):(e=o.URLS.API_BASE_URL+o.URLS.API_PUBLICATION_RETRIEVE,t={uid:d.uid},$.get(e,t).done(e=>{setTimeout(()=>{n.trigger("setup:issueDownload",e)},o.MISC.UI_UPDATE_DELAY)}).fail(()=>{setTimeout(()=>{n.trigger("setup:issueDownload:error")},o.MISC.UI_UPDATE_DELAY)}))}),n.on("setup:issueDownload",e=>{d.decode(e.issue),n.trigger("setup:complete")}),n.on("setup:issueDownload:error",e=>{alert("TODO: handle issue download error")}),n.on("setup:begin",()=>{a.displayFeedback("Initializing errata editor")}),n.on("setup:complete",()=>{setTimeout(()=>{a.hideFeedback()},o.MISC.UI_UPDATE_DELAY)}),n.on("setup:setupDataDownload:error",()=>{alert("TODO: setup:setupDataDownload:error")}),n.on("errata:save:invalidated",()=>{a.displayInfoDialog("Errata is invalid - please correct errors & try again.")}),n.on("errata:save:dispatch:starts",()=>{a.displayFeedback("Saving errata details")}),n.on("errata:save:dispatch:success",()=>{let e="Errata details have been successfully saved.";u.isAnonymous&&(e+="  A system moderator will review the details and contact you in due course."),a.hideFeedback(),a.displayInfoDialog(e,()=>{n.trigger("errata:save:complete")})}),n.on("errata:save:dispatch:error",e=>{a.hideFeedback(),e&&e.responseJSON&&e.responseJSON.errorCode?a.displayInfoDialog(`Errata is invalid - ${e.responseJSON.errorMessage}.`):a.displayInfoDialog("An error occurred whilst saving the errata details - please try again.  If the problem persists then contact support.")}),n.on("errata:moderate:dispatch:starts",()=>{a.displayFeedback("Saving errata moderation status")}),n.on("errata:moderate:dispatch:error",()=>{a.hideFeedback(),a.displayInfoDialog("An error occurred whilst saving the errata moderation status - please try again.  If the problem persists then contact support.")}),n.on("errata:moderate:dispatch:success",e=>{let t="Moderation status has been sucessfully updated.  ";e.moderationStatus==o.ISSUE.MODERATION_STATUS_ACCEPTED?t+="  An acceptance email has been sent to the errata proposer.":e.moderationStatus==o.ISSUE.MODERATION_STATUS_REJECTED&&(t+="  A rejection email has been sent to the errata proposer."),a.hideFeedback(),a.displayInfoDialog(t,()=>{n.trigger("errata:moderate:complete")})}),n.on("errata:save:dispatch",()=>{const e=d.encode();let t=o.URLS.API_BASE_URL;u.isAnonymous?t+=d.isNew?o.URLS.API_PUBLICATION_PROPOSE:o.URLS.API_PUBLICATION_UPDATE:t+=d.isNew?o.URLS.API_PUBLICATION_CREATE:o.URLS.API_PUBLICATION_UPDATE,g(t,e,"errata:save:dispatch")}),n.on("errata:moderate",e=>{const t={uid:d.uid,moderationStatus:e},r=o.URLS.API_BASE_URL+o.URLS.API_PUBLICATION_MODERATE;g(r,t,"errata:moderate:dispatch")});const g=(e,t,r)=>{n.trigger(`${r}:starts`);let i={"Content-Type":"application/json; charset=UTF-8","X-XSRFToken":Cookies.get("_xsrf")};!1===u.isAnonymous&&(i={Authorization:u.oauthCredentials,...i}),$.ajax({method:"POST",url:e,data:JSON.stringify(t),dataType:"json",headers:i}).always(e=>{200===e.status?n.trigger(`${r}:success`,t):n.trigger(`${r}:error`,e)})};$(document).ready(()=>{PYESSV.initialise(()=>{n.trigger("setup:begin")})}),n.on("setup:complete",()=>{var e;(e=new E).render(),$("body").append(e.el),n.trigger("ui:initialized")}),n.on("errata:save:complete",()=>{let e=o.URLS.PAGE_VIEW;e+="?uid=",e+=d.uid,a.openURL(e)}),n.on("errata:moderate:complete",()=>{let e=o.URLS.PAGE_EDIT;e+="?uid=",e+=d.uid,a.openURL(e)}),window.APP=n,window.CONSTANTS=o,window.STATE=i,window.UTILS=a}]);